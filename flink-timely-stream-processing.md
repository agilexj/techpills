# Timely Stream Processing

## Introduction

Event time can progress independently of processing time (measured by wall clocks). For example, in one program the current event time of an operator may trail slightly behind the processing time (accounting for a delay in receiving the events), while both proceed at the same speed. On the other hand, another streaming program might progress through weeks of event time with only a few seconds of processing, by fast-forwarding through some historic data already buffered in a Kafka topic (or another message queue).

The mechanism in Flink to measure progress in event time is watermarks. Watermarks flow as part of the data stream and carry a timestamp t. A Watermark(t) declares that event time has reached time t in that stream, meaning that there should be no more elements from the stream with a timestamp tâ€™ <= t

## Watermarks measures progress of event time

![](/pics/watermark.png)

* **The watermarks have been generated by assuming that the stream is at most 5 minutes out-of-order.**
* **Each watermark is the max timestamp seen so far, minus this out-of-orderness estimate.**
* **A watermark is an assertion about the completeness of the stream. No earlier events are expected to follow. If the do occur, they violate our assumption that our stream is no more that 5 minutes out-of-order, and such events might be considered late**

**Imagine a window counting events for the hour ending at 2:00. How long should this window wait before producing its result?**

It should wait for a **watermark** with a timestamp of at least 2:00.

Watermarks come from a **generator** that runs inside each Flink's Kafka consumers.

## The watermarks that windows need come from watermarks generators in the sources 

![](/pics/parallel.png)

Both the source and the window have a parallelism of two, and the window is counting events by color, which is why the sources are connected to the windows by a network shuffle that implements this re-partitioning.

In this example, each instance of the Kafka source operator is reading from two Kafka partitions.

A sample event is a key/value pair formed with a key and the corresponding timestamp: `A|1:10`

A source generates a watermark every 2.5 milliseconds by first computing the watermark for each partition independently (using the same five-minute out-of-order estimate).

![](/pics/per-partition-wm.png)

The watermark that the Kafka source produces is the minimum of these per-partition watermarks.

The watermark that this source produces should carry a timestamp that reflect how complete the stream is so far. It can be no more complete than the furthest behind of the two partitions (0 in the example).

## What is the current watermark at the window? It is min(incoming WMs)

![](/pics/window-wm.png)

After generating this watermark the source sends it downstream to both window operators. The watermark at the window will need to somehow reflect the watermarks coming in from each of the two sources.

Lacking any event coming from Partition 1, the second Kafka source, when asked for watermark will send this information downstream (No WM)

![](/pics/no-wm.png)

What is the current watermark at the window? The current watermark for any window operator with multiple inputs is the minimum of the incoming watermarks. In this case the window operators don't yet have a useful watermark. This is because no events have been processed for Partition 1.

As soon as Partition 1 has an event, the second source can produce a good watermark, which will flow downstream.

![](/pics/valid-wm.png)

Now the watermark at the window operator, for both instances, has advanced, but until these watermarks reach two o'clock, the results that are been accumulated inside the window won't be emitted.

## Why isn't my Flink job producing any results?

### The idle stream problem

* Streams that are idle do not advance the watermark 
* This prevents windows from producing results 

In the previous example, what if Partition 1 have never had any events at all? In that case the watermark would never have advanced. Similarly, whenever any partition becomes idle the watermarks will stall. Events from other partitions may continue to flow, and the windows will continue to collect results, but no results will be reported until the idle partition has new events.

### Solutions 

* Balance the partitions so none are empty or idle, or
* Artificially keep the partition active by including keep-alive events. 
* Or you can configure Flink to time-out idle partitions and ignore their idleness.

## A few last details 

* 5 minutes is a very long out-of-orderness interval.
    * E.g., the window fro 1:00-2:00 won't produce any results until 2:05.